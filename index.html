<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Charmers Bracelets Checkout</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
<header>
    <h1>Charmers Bracelets</h1>
</header>

<div class="banner">
    We're on eBay! <a href="https://ebay.us/m/S51i6y" target="_blank" rel="noopener">Visit our store</a>
</div>

<main>
    <div class="checkout-flow">
        <div class="flow-indicator">
            <div class="flow-dot active" id="dot-1"></div>
            <div class="flow-dot" id="dot-2"></div>
            <div class="flow-dot" id="dot-3"></div>
            <div class="flow-dot" id="dot-4"></div>
        </div>

        <!-- STEP 1: PRODUCT SELECTION -->
        <div id="step-1" class="flow-step active">
            <h2 class="flow-title">Choose Your Bracelet</h2>

            <div class="product-gallery">
                <!-- Charmers Birthstone Series -->
                <div class="product-card" data-product="birthstone">
                    <div class="product-image">
                        <img src="7F01BE54-F5B3-4F37-816C-EE1CA521403D.png" alt="Charmers Birthstone Series">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">Charmers Birthstone Series</h3>
                        <p class="product-price">Starting at $5</p>
                        <p class="product-description">
                            Personalized birthstone bracelet. 10% of profits donated to Montessori School of Franklin.
                        </p>
                        <button class="select-btn" data-select="birthstone">Select This Bracelet</button>
                    </div>
                </div>

                <!-- Charmers Heart Bracelet -->
                <div class="product-card" data-product="heart">
                    <div class="product-image">
                        <img src="8A96249A-B878-4532-8017-920184790BF7.png" alt="Charmers Heart Bracelet">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">Charmers Heart Bracelet</h3>
                        <p class="product-price">Starting at $5</p>
                        <p class="product-description">
                            Beautiful pink & purple heart design. Perfect for any occasion.
                        </p>
                        <button class="select-btn" data-select="heart">Select This Bracelet</button>
                    </div>
                </div>

                <!-- Charmers Custom Bracelet -->
                <div class="product-card" data-product="custom">
                    <div class="product-image">
                        <img src="E426020E-70F9-4E87-904C-A8AC91F9AC18.png" alt="Charmers Custom Bracelet">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">Create Your Own Bracelet</h3>
                        <p class="product-price">Starting at $5</p>
                        <p class="product-description">
                            Design your own unique bracelet. Choose colors, theme, and more!
                        </p>
                        <button class="select-btn" data-select="custom">Create Custom Bracelet</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: CUSTOMIZATION -->
        <div id="step-2" class="flow-step">
            <h2 class="flow-title">Customize Your <span id="product-name">Bracelet</span></h2>

            <div class="product-summary">
                <h3>Selected: <span id="selected-product-name">Bracelet</span></h3>
            </div>

            <!-- Birthstone customization -->
            <div id="birthstone-customization" class="bracelet-customization" style="display:none;">
                <label for="birthstone-input">Your birthstone month *</label>
                <input id="birthstone-input" type="text" placeholder="e.g., April, May, Emerald" class="customization-input" />

                <label>Select size *</label>
                <div class="size-options">
                    <div class="size-option" data-size="small" data-price="5">
                        Small<br /><span class="size-price">$5</span>
                    </div>
                    <div class="size-option" data-size="medium" data-price="9">
                        Medium<br /><span class="size-price">$9</span>
                    </div>
                    <div class="size-option" data-size="large" data-price="11">
                        Large<br /><span class="size-price">$11</span>
                    </div>
                    <div class="size-option" data-size="xlarge" data-price="15">
                        X-Large<br /><span class="size-price">$15</span>
                    </div>
                </div>

                <label for="birthstone-personalization">Personalization text (optional)</label>
                <textarea id="birthstone-personalization" rows="3" placeholder="Add a special message or name" class="customization-input"></textarea>
            </div>

            <!-- Heart customization -->
            <div id="heart-customization" class="bracelet-customization" style="display:none;">
                <p style="color:#6b7280;font-style:italic;">Colors fixed to pink &amp; purple.</p>

                <label>Select size *</label>
                <div class="size-options">
                    <div class="size-option" data-size="small" data-price="5">
                        Small<br /><span class="size-price">$5</span>
                    </div>
                    <div class="size-option" data-size="medium" data-price="9">
                        Medium<br /><span class="size-price">$9</span>
                    </div>
                    <div class="size-option" data-size="large" data-price="11">
                        Large<br /><span class="size-price">$11</span>
                    </div>
                    <div class="size-option" data-size="xlarge" data-price="15">
                        X-Large<br /><span class="size-price">$15</span>
                    </div>
                </div>

                <label for="heart-personalization">Personalization text (optional)</label>
                <textarea id="heart-personalization" rows="3" placeholder="Add a special message or name" class="customization-input"></textarea>
            </div>

            <!-- Custom bracelet customization -->
            <div id="custom-customization" class="bracelet-customization" style="display:none;">
                <label for="custom-feature">What do you want it to feature? *</label>
                <input id="custom-feature" type="text" placeholder="Describe your design or theme" class="customization-input" />

                <label for="custom-color">Primary color</label>
                <select id="custom-color" class="customization-input">
                    <option value="">Select a color</option>
                    <option value="red">Red</option>
                    <option value="pink">Pink</option>
                    <option value="purple">Purple</option>
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="yellow">Yellow</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                </select>

                <label for="custom-color-custom">Or enter custom color</label>
                <input id="custom-color-custom" type="text" placeholder="Custom color name" class="customization-input" />

                <label for="custom-color2">Optional second color</label>
                <select id="custom-color2" class="customization-input">
                    <option value="">Select a color (optional)</option>
                    <option value="red">Red</option>
                    <option value="pink">Pink</option>
                    <option value="purple">Purple</option>
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="yellow">Yellow</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                </select>

                <label>Select size *</label>
                <div class="size-options">
                    <div class="size-option" data-size="small" data-price="5">
                        Small<br /><span class="size-price">$5</span>
                    </div>
                    <div class="size-option" data-size="medium" data-price="9">
                        Medium<br /><span class="size-price">$9</span>
                    </div>
                    <div class="size-option" data-size="large" data-price="11">
                        Large<br /><span class="size-price">$11</span>
                    </div>
                    <div class="size-option" data-size="xlarge" data-price="15">
                        X-Large<br /><span class="size-price">$15</span>
                    </div>
                </div>

                <label for="donation">Donate to (optional)</label>
                <select id="donation" class="customization-input">
                    <option value="remove_co2">Remove CO‚ÇÇ from our environment</option>
                    <option value="msf">Montessori School of Franklin</option>
                    <option value="none">No donation</option>
                </select>

                <label for="custom-personalization">Personalization text (optional)</label>
                <textarea id="custom-personalization" rows="3" placeholder="Add a special message or name" class="customization-input"></textarea>
            </div>

            <div class="flow-navigation">
                <button class="nav-btn secondary" type="button" onclick="goToStep(1)">‚Üê Back</button>
                <button class="nav-btn" type="button" onclick="goToStep(3)">Continue to Shipping ‚Üí</button>
            </div>
        </div>

        <!-- STEP 3: SHIPPING -->
        <div id="step-3" class="flow-step">
            <h2 class="flow-title">Shipping Information</h2>

            <div class="product-summary" id="order-summary">
                <!-- Filled by JS -->
            </div>

            <div class="section">
                <label for="shipping-option">Shipping method *</label>
                <select id="shipping-option" required>
                    <option value="">Select shipping</option>
                    <option value="usps_ground" data-price="9">USPS Ground Advantage ‚Äî $9</option>
                    <option value="usps_priority" data-price="11">USPS Priority Mail ‚Äî $11</option>
                    <option value="usps_express" data-price="29">USPS Priority Mail Express ‚Äî $29</option>
                    <option value="ups_exp" data-price="93">UPS Worldwide Expedited ‚Äî $93</option>
                    <option value="ups_expr" data-price="119">UPS Worldwide Express ‚Äî $119</option>
                </select>

                <h3 style="margin-top:24px;">Shipping Address</h3>

                <label for="name">Full name *</label>
                <input id="name" type="text" placeholder="Your full name" required />

                <label for="email">Email address *</label>
                <input id="email" type="email" placeholder="you@example.com" required />

                <label for="phone">Phone number (optional)</label>
                <input id="phone" type="tel" placeholder="(123) 456-7890" />

                <label for="address1">Street address *</label>
                <input id="address1" type="text" placeholder="123 Main St" required />

                <label for="address2">Apartment, suite, etc. (optional)</label>
                <input id="address2" type="text" placeholder="Apt 4B" />

                <div class="inline-group">
                    <div>
                        <label for="city">City *</label>
                        <input id="city" type="text" placeholder="City" required />
                    </div>
                    <div>
                        <label for="state">State / Province *</label>
                        <input id="state" type="text" placeholder="State" required />
                    </div>
                </div>

                <div class="inline-group">
                    <div>
                        <label for="postal">ZIP / Postal code *</label>
                        <input id="postal" type="text" placeholder="12345" required />
                    </div>
                    <div>
                        <label for="country">Country *</label>
                        <input id="country" type="text" placeholder="United States" required />
                    </div>
                </div>
            </div>

            <div class="flow-navigation">
                <button class="nav-btn secondary" type="button" onclick="goToStep(2)">‚Üê Back</button>
                <button class="nav-btn" type="button" onclick="goToStep(4)">Continue to Payment ‚Üí</button>
            </div>
        </div>

        <!-- STEP 4: PAYMENT -->
        <div id="step-4" class="flow-step">
            <h2 class="flow-title">Payment</h2>

            <div class="section">
                <div id="payment-request-button" class="hidden"></div>

                <div id="card-element" style="margin-top:16px;"></div>

                <div id="card-errors" role="alert" style="color:#b91c1c;margin-top:8px;font-size:0.9rem;"></div>

                <button id="card-button" class="nav-btn" style="width:100%;margin-top:18px;" type="button">
                    Pay Now
                </button>
            </div>

            <div class="flow-navigation">
                <button class="nav-btn secondary" type="button" onclick="goToStep(3)">‚Üê Back to Shipping</button>
            </div>
        </div>

        <!-- SUCCESS -->
        <div id="step-success" class="flow-step">
            <div style="text-align:center;padding:40px 20px;">
                <h2 style="color:#5a17ff;font-size:1.6rem;">üéâ Order Successful!</h2>
                <p>Your payment was successful and your order has been saved to our system.</p>
                <p>Expect a confirmation email from Charmers soon.</p>
                <button id="dashboard-button" class="nav-btn" style="margin-top:20px;" type="button">
                    View Order Dashboard
                </button>
            </div>
        </div>
    </div>
</main>

<!-- CART SUMMARY STICKY BAR -->
<div class="cart-summary" id="cart-summary">
    <div class="cart-item">
        <span id="cart-product-name">No product selected</span>
        <span id="cart-product-price">$0.00</span>
    </div>
    <div class="cart-item">
        <span>Shipping</span>
        <span id="cart-shipping-price">$0.00</span>
    </div>
    <div class="cart-item">
        <strong>Total</strong>
        <strong id="cart-total-price">$0.00</strong>
    </div>
    <button id="checkout-btn" class="nav-btn" type="button" disabled>Proceed to Checkout</button>
</div>

<script>
    // Config
    const BACKEND_URL = 'https://pay-charmersv2.onrender.com';
    const stripePublicKey = 'pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc';
    const paymentIntentUrl = BACKEND_URL + '/create-payment-intent';
    const saveOrderUrl = BACKEND_URL + '/save-order';

    // State
    let selectedProduct = null;
    let selectedSize = null;
    let braceletPrice = 0;
    let shippingPrice = 0;
    let currentStep = 1;
    let stripe, elements, card;

    // Payment Request global refs (so totals + shipping stay in sync)
    let paymentRequest = null;
    let prButton = null;

    const products = {
        birthstone: { name: 'Birthstone Bracelet', basePrice: 5, customization: 'birthstone' },
        heart: { name: 'Heart Bracelet', basePrice: 5, customization: 'heart' },
        custom: { name: 'Custom Bracelet', basePrice: 5, customization: 'custom' }
    };

    const SHIPPING_OPTIONS = [
        { id: 'usps_ground', label: 'USPS Ground Advantage', detail: '2‚Äì10 business days', amount: 900 },
        { id: 'usps_priority', label: 'USPS Priority Mail', detail: '2‚Äì5 business days', amount: 1100 },
        { id: 'usps_express', label: 'USPS Priority Mail Express', detail: '2‚Äì3 business days', amount: 2900 },
        { id: 'ups_exp', label: 'UPS Worldwide Expedited', detail: '5‚Äì7 business days', amount: 9300 },
        { id: 'ups_expr', label: 'UPS Worldwide Express', detail: '3‚Äì5 business days', amount: 11900 }
    ];

    function getShippingById(id) {
        return SHIPPING_OPTIONS.find(o => o.id === id);
    }

    function syncPaymentRequestTotal() {
        if (!paymentRequest) return;
        paymentRequest.update({
            total: {
                label: 'Charmers Order',
                amount: Math.round((braceletPrice + shippingPrice) * 100)
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        initStripe();
        initProductButtons();
        initSizeSelection();
        initShippingListeners();
        updateCartSummary();
        testBackendConnection();
    });

    function initStripe() {
        stripe = Stripe(stripePublicKey);
        elements = stripe.elements();
        const style = {
            base: {
                color: '#111827',
                fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                fontSize: '16px',
                '::placeholder': { color: '#9ca3af' }
            },
            invalid: {
                color: '#b91c1c',
                iconColor: '#b91c1c'
            }
        };
        card = elements.create('card', { style });
        card.mount('#card-element');
        card.on('change', function (event) {
            const displayError = document.getElementById('card-errors');
            displayError.textContent = event.error ? event.error.message : '';
        });
        initPaymentRequestButton();
    }

    function initPaymentRequestButton() {
        paymentRequest = stripe.paymentRequest({
            country: 'US',
            currency: 'usd',
            total: { label: 'Charmers Order', amount: Math.round((braceletPrice + shippingPrice) * 100) },
            requestPayerName: true,
            requestPayerEmail: true,
            requestPayerPhone: true,
            requestShipping: true,
            shippingOptions: SHIPPING_OPTIONS
        });

        prButton = elements.create('paymentRequestButton', {
            paymentRequest,
            style: {
                paymentRequestButton: {
                    theme: 'dark',
                    height: '48px'
                }
            }
        });

        paymentRequest.canMakePayment().then(function (result) {
            if (result) {
                const container = document.getElementById('payment-request-button');
                container.classList.remove('hidden');
                prButton.mount('#payment-request-button');
            }
        });

        // Keep totals in sync when user changes shipping inside Apple Pay / Google Pay / Link
        paymentRequest.on('shippingoptionchange', function (ev) {
            const opt = getShippingById(ev.shippingOption.id);
            if (opt) {
                shippingPrice = opt.amount / 100;

                // mirror selection back to your dropdown
                const shippingSelect = document.getElementById('shipping-option');
                if (shippingSelect) {
                    shippingSelect.value = opt.id;
                }

                updateCartSummary();
                updateOrderSummary();

                ev.updateWith({
                    status: 'success',
                    total: {
                        label: 'Charmers Order',
                        amount: Math.round((braceletPrice + shippingPrice) * 100)
                    }
                });
            } else {
                ev.updateWith({ status: 'fail' });
            }
        });

        // Your requested paymentmethod handler (with 3DS handling)
        paymentRequest.on('paymentmethod', async ev => {
            try {
                // ‚úÖ Validate before doing anything
                if (!validateShippingForm() || !validateCustomization()) {
                    ev.complete('fail');
                    return;
                }

                const orderData = prepareOrderData();
                const amountCents = Math.round(orderData.total * 100);

                // ‚úÖ Create PaymentIntent on backend
                const res = await fetch(paymentIntentUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amountCents,
                        currency: 'usd',
                        orderDetails: orderData.orderDetails,
                        customerInfo: orderData.customerInfo,
                        shipping: orderData.shipping
                    })
                });

                const pi = await res.json();
                if (pi.error || !pi.clientSecret) {
                    ev.complete('fail');
                    return;
                }

                // ‚úÖ Confirm payment (NO updateWith here)
                const { error, paymentIntent } = await stripe.confirmCardPayment(
                    pi.clientSecret,
                    {
                        payment_method: ev.paymentMethod.id
                    },
                    { handleActions: false }
                );

                if (error) {
                    ev.complete('fail');
                    return;
                }

                // ‚úÖ Handle required actions (3DS, etc.)
                if (paymentIntent.status === 'requires_action') {
                    const { error: actionError, paymentIntent: finalIntent } =
                        await stripe.confirmCardPayment(pi.clientSecret);

                    if (actionError) {
                        ev.complete('fail');
                        return;
                    }

                    await saveOrderToBackend(finalIntent.id, orderData);
                } else {
                    await saveOrderToBackend(paymentIntent.id, orderData);
                }

                // ‚úÖ Tell Apple Pay / Google Pay we're done
                ev.complete('success');
                showSuccess();

            } catch (err) {
                console.error(err);
                ev.complete('fail');
            }
        });
    }

    function initProductButtons() {
        document.querySelectorAll('.select-btn[data-select]').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const productType = this.getAttribute('data-select');
                selectProduct(productType, this);
            });
        });

        document.getElementById('checkout-btn').addEventListener('click', function () {
            if (!selectedProduct) {
                alert('Please select a bracelet first.');
                return;
            }
            goToStep(2);
        });
    }

    function selectProduct(productType, buttonEl) {
        selectedProduct = productType;

        document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
        const cardEl = document.querySelector('.product-card[data-product="' + productType + '"]');
        if (cardEl) cardEl.classList.add('selected');

        document.querySelectorAll('.select-btn[data-select]').forEach(btn => {
            btn.classList.remove('selected');
            btn.textContent = btn.getAttribute('data-select') === productType ? '‚úì Selected' : 'Select This Bracelet';
        });
        buttonEl.classList.add('selected');
        buttonEl.textContent = '‚úì Selected';

        document.getElementById('cart-summary').classList.add('show');
        document.getElementById('checkout-btn').disabled = false;

        document.getElementById('product-name').textContent = products[productType].name;
        document.getElementById('selected-product-name').textContent = products[productType].name;

        braceletPrice = products[productType].basePrice;
        selectedSize = null;
        updateCartSummary();
        updateOrderSummary();
    }

    function initSizeSelection() {
        document.addEventListener('click', function (e) {
            const option = e.target.closest('.size-option');
            if (!option) return;
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
            option.classList.add('selected');

            selectedSize = option.getAttribute('data-size');
            braceletPrice = parseFloat(option.getAttribute('data-price')) || 0;
            updateCartSummary();
            updateOrderSummary();
        });

        document.querySelectorAll('.customization-input').forEach(function (input) {
            input.addEventListener('input', updateOrderSummary);
            input.addEventListener('change', updateOrderSummary);
        });
    }

    function initShippingListeners() {
        const shippingSelect = document.getElementById('shipping-option');
        shippingSelect.addEventListener('change', function () {
            const selectedOption = shippingSelect.options[shippingSelect.selectedIndex];
            shippingPrice = parseFloat(selectedOption.dataset.price || '0');
            updateCartSummary();
            updateOrderSummary();
        });

        document.getElementById('card-button').addEventListener('click', handleCardPayment);

        document.getElementById('dashboard-button').addEventListener('click', function () {
            window.open(BACKEND_URL + '/dashboard', '_blank');
        });
    }

    function goToStep(step) {
        if (step > currentStep) {
            if (currentStep === 1 && !selectedProduct) {
                alert('Please select a bracelet first.');
                return;
            }
            if (currentStep === 2 && !validateCustomization()) {
                return;
            }
            if (currentStep === 3 && !validateShippingForm()) {
                return;
            }
        }

        document.querySelectorAll('.flow-step').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('step-' + step);
        if (target) target.classList.add('active');

        document.querySelectorAll('.flow-dot').forEach((dot, idx) => {
            dot.classList.toggle('active', idx < step);
        });

        currentStep = step;

        if (step === 2 && selectedProduct) {
            showCustomization(selectedProduct);
            updateOrderSummary();
        }
        if (step === 4) {
            updateOrderSummary();
            syncPaymentRequestTotal();
        }
    }

    function showCustomization(productType) {
        document.querySelectorAll('.bracelet-customization').forEach(el => {
            el.style.display = 'none';
        });
        const id = products[productType].customization + '-customization';
        const block = document.getElementById(id);
        if (block) block.style.display = 'block';

        document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
        selectedSize = null;
        braceletPrice = products[productType].basePrice;
        updateCartSummary();
    }

    function validateCustomization() {
        if (!selectedSize) {
            alert('Please select a size.');
            return false;
        }
        if (selectedProduct === 'birthstone') {
            const val = document.getElementById('birthstone-input').value.trim();
            if (!val) {
                alert('Please enter your birthstone month.');
                return false;
            }
        }
        if (selectedProduct === 'custom') {
            const feature = document.getElementById('custom-feature').value.trim();
            if (!feature) {
                alert('Please describe what you want your bracelet to feature.');
                return false;
            }
        }
        return true;
    }

    function validateShippingForm() {
        const requiredIds = ['shipping-option', 'name', 'email', 'address1', 'city', 'state', 'postal', 'country'];
        for (const id of requiredIds) {
            const el = document.getElementById(id);
            if (!el || !el.value.trim()) {
                alert('Please fill in ' + (el.placeholder || id) + '.');
                if (el) el.focus();
                return false;
            }
        }
        const emailVal = document.getElementById('email').value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailVal)) {
            alert('Please enter a valid email address.');
            return false;
        }

        const shippingSelect = document.getElementById('shipping-option');
        const opt = shippingSelect.options[shippingSelect.selectedIndex];
        shippingPrice = parseFloat(opt.dataset.price || '0');
        updateCartSummary();
        return true;
    }

    function updateCartSummary() {
        const nameSpan = document.getElementById('cart-product-name');
        const priceSpan = document.getElementById('cart-product-price');
        const shipSpan = document.getElementById('cart-shipping-price');
        const totalSpan = document.getElementById('cart-total-price');
        if (selectedProduct) {
            nameSpan.textContent = products[selectedProduct].name;
            priceSpan.textContent = '$' + braceletPrice.toFixed(2);
        } else {
            nameSpan.textContent = 'No product selected';
            priceSpan.textContent = '$0.00';
        }
        shipSpan.textContent = '$' + shippingPrice.toFixed(2);
        const total = braceletPrice + shippingPrice;
        totalSpan.textContent = '$' + total.toFixed(2);
        const checkoutBtn = document.getElementById('checkout-btn');
        if (checkoutBtn) {
            checkoutBtn.textContent = 'Checkout - $' + total.toFixed(2);
        }
        syncPaymentRequestTotal();
    }

    function updateOrderSummary() {
        const div = document.getElementById('order-summary');
        let html = '<h3>Order Summary</h3>';
        if (!selectedProduct) {
            html += '<p>No product selected.</p>';
            div.innerHTML = html;
            return;
        }
        html += '<p><strong>Product:</strong> ' + products[selectedProduct].name + '</p>';
        html += '<p><strong>Size:</strong> ' + (selectedSize ? (selectedSize.charAt(0).toUpperCase() + selectedSize.slice(1)) : 'Not selected') + '</p>';

        if (selectedProduct === 'birthstone') {
            const birthstone = document.getElementById('birthstone-input').value.trim();
            const pers = document.getElementById('birthstone-personalization').value.trim();
            if (birthstone) html += '<p><strong>Birthstone:</strong> ' + birthstone + '</p>';
            if (pers) html += '<p><strong>Personalization:</strong> ' + pers + '</p>';
        } else if (selectedProduct === 'heart') {
            const pers = document.getElementById('heart-personalization').value.trim();
            if (pers) html += '<p><strong>Personalization:</strong> ' + pers + '</p>';
        } else if (selectedProduct === 'custom') {
            const feature = document.getElementById('custom-feature').value.trim();
            const color = document.getElementById('custom-color').value || document.getElementById('custom-color-custom').value;
            const color2 = document.getElementById('custom-color2').value;
            const donation = document.getElementById('donation').value;
            const pers = document.getElementById('custom-personalization').value.trim();
            if (feature) html += '<p><strong>Feature:</strong> ' + feature + '</p>';
            if (color) html += '<p><strong>Primary color:</strong> ' + color + '</p>';
            if (color2) html += '<p><strong>Second color:</strong> ' + color2 + '</p>';
            if (donation && donation !== 'none') html += '<p><strong>Donation:</strong> ' + donation + '</p>';
            if (pers) html += '<p><strong>Personalization:</strong> ' + pers + '</p>';
        }

        html += '<p><strong>Bracelet Price:</strong> $' + braceletPrice.toFixed(2) + '</p>';
        html += '<p><strong>Shipping:</strong> $' + shippingPrice.toFixed(2) + '</p>';
        html += '<p style="font-size:1.1rem;color:#5a17ff;margin-top:10px;"><strong>Total: $' +
            (braceletPrice + shippingPrice).toFixed(2) + '</strong></p>';

        div.innerHTML = html;
        syncPaymentRequestTotal();
    }

    function prepareOrderData() {
        const total = braceletPrice + shippingPrice;
        const type = selectedProduct;

        const orderDetails = {
            braceletType: type,
            total: total,
            size: selectedSize
        };

        if (type === 'birthstone') {
            orderDetails.birthstone = document.getElementById('birthstone-input').value.trim();
            orderDetails.personalization = document.getElementById('birthstone-personalization').value.trim();
        } else if (type === 'heart') {
            orderDetails.personalization = document.getElementById('heart-personalization').value.trim();
        } else if (type === 'custom') {
            orderDetails.feature = document.getElementById('custom-feature').value.trim();
            orderDetails.color = document.getElementById('custom-color').value ||
                document.getElementById('custom-color-custom').value.trim();
            orderDetails.color2 = document.getElementById('custom-color2').value;
            orderDetails.donation = document.getElementById('donation').value;
            orderDetails.personalization = document.getElementById('custom-personalization').value.trim();
        }

        const customerInfo = {
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim()
        };

        const shipping = {
            address1: document.getElementById('address1').value.trim(),
            address2: document.getElementById('address2').value.trim(),
            city: document.getElementById('city').value.trim(),
            state: document.getElementById('state').value.trim(),
            postal: document.getElementById('postal').value.trim(),
            country: document.getElementById('country').value.trim(),
            shippingOption: document.getElementById('shipping-option').value
        };

        return { total, orderDetails, customerInfo, shipping };
    }

    async function saveOrderToBackend(paymentIntentId, orderData) {
        try {
            const res = await fetch(saveOrderUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paymentIntentId: paymentIntentId,
                    status: 'completed',
                    customerInfo: orderData.customerInfo,
                    orderDetails: orderData.orderDetails,
                    shipping: orderData.shipping,
                    amount: orderData.total
                })
            });
            const result = await res.json();
            if (result.success) {
                console.log('Order saved to backend:', result.orderId);
                localStorage.setItem('hasOrdered', 'yes');
            } else {
                console.warn('Backend save failed:', result.error || result);
            }
            return result;
        } catch (err) {
            console.error('Failed to save order to backend:', err);
            return { success: false, error: err.message };
        }
    }

    async function handleCardPayment() {
        const button = document.getElementById('card-button');
        if (!validateShippingForm()) return;
        if (!validateCustomization()) return;

        button.disabled = true;
        button.textContent = 'Processing...';

        const orderData = prepareOrderData();
        const amountCents = Math.round(orderData.total * 100);

        let pi;
        try {
            const res = await fetch(paymentIntentUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: amountCents,
                    currency: 'usd',
                    orderDetails: orderData.orderDetails,
                    customerInfo: orderData.customerInfo,
                    shipping: orderData.shipping
                })
            });
            pi = await res.json();
        } catch (err) {
            document.getElementById('card-errors').textContent =
                'Error contacting payment server. Please try again.';
            button.disabled = false;
            button.textContent = 'Pay Now';
            return;
        }

        if (pi.error || !pi.clientSecret) {
            document.getElementById('card-errors').textContent =
                pi.error || 'Unable to create payment. Try again later.';
            button.disabled = false;
            button.textContent = 'Pay Now';
            return;
        }

        const { error, paymentIntent } = await stripe.confirmCardPayment(pi.clientSecret, {
            payment_method: {
                card: card,
                billing_details: {
                    name: orderData.customerInfo.name,
                    email: orderData.customerInfo.email,
                    phone: orderData.customerInfo.phone,
                    address: {
                        line1: orderData.shipping.address1,
                        line2: orderData.shipping.address2,
                        city: orderData.shipping.city,
                        state: orderData.shipping.state,
                        postal_code: orderData.shipping.postal,
                        country: orderData.shipping.country
                    }
                }
            }
        });

        if (error) {
            let msg = error.message || 'Payment failed. Please try again.';
            if (error.code === 'card_declined' && error.decline_code === 'insufficient_funds') {
                msg = 'The card was declined by your bank, try again later (code: insufficient_funds).';
            } else if (error.code === 'invalid_number' || error.code === 'incorrect_number') {
                msg = 'Check the card number (code: ' + error.code + ').';
            } else if (error.code === 'expired_card') {
                msg = 'Your card has expired. Please use a different card.';
            } else if (error.code === 'incorrect_cvc') {
                msg = 'The CVC number is incorrect. Please check and try again.';
            }
            document.getElementById('card-errors').textContent = msg;
            button.disabled = false;
            button.textContent = 'Pay Now';
            return;
        }

        if (paymentIntent && paymentIntent.status === 'succeeded') {
            await saveOrderToBackend(paymentIntent.id, orderData);
            showSuccess();
        } else {
            document.getElementById('card-errors').textContent =
                'Payment processing... Please check your email for confirmation.';
        }

        button.disabled = false;
        button.textContent = 'Pay Now';
    }

    function showSuccess() {
        document.querySelectorAll('.flow-step').forEach(el => el.classList.remove('active'));
        document.getElementById('step-success').classList.add('active');
        document.querySelectorAll('.flow-dot').forEach(dot => dot.classList.add('active'));
        document.getElementById('cart-summary').classList.remove('show');
    }

    async function testBackendConnection() {
        try {
            const res = await fetch(BACKEND_URL + '/health');
            const data = await res.json();
            console.log('Backend connected:', data.status || data);
        } catch (err) {
            console.warn('Backend connection test failed:', err.message);
        }
    }
</script>
</body>
</html>
