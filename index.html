<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmers Checkout</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>

<!-- reCAPTCHA Enterprise -->
<script src="https://www.google.com/recaptcha/enterprise.js?render=6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></script>

<!-- Google Maps Autocomplete -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=REPLACE_WITH_YOUR_MAPS_KEY&libraries=places">
</script>

<style>
:root {
    --pink: #ff4fe0;
    --purple: #7a2bff;
}
</style>
</head>
<body class="bg-gray-100">

<div class="max-w-xl mx-auto bg-white p-6 my-10 rounded-xl shadow">

<h1 class="text-3xl font-bold text-purple-700 mb-4 text-center">
Charmers Custom Bracelet Checkout
</h1>

<!-- FORM -->
<div class="space-y-4">

<input id="name" class="w-full p-3 border rounded" placeholder="Full Name">
<input id="email" class="w-full p-3 border rounded" placeholder="Email">
<input id="phone" class="w-full p-3 border rounded" placeholder="Phone (optional)">
<textarea id="bracelet" class="w-full p-3 border rounded" placeholder="Bracelet Text"></textarea>

<!-- Shipping -->
<select id="shipping" class="w-full p-3 border rounded">
<option value="">Select Shipping</option>
<option value="9">Ground Advantage — $9</option>
<option value="13">Priority Mail — $13</option>
<option value="25">Priority Mail Express — $25</option>
<option value="47">First Class International — $47</option>
<option value="78">Priority Mail International — $78</option>
</select>

<!-- Processing -->
<select id="processing" class="w-full p-3 border rounded">
<option value="">Select Processing</option>
<option value="0.50">Charmers 24 Hour Processing — $0.50</option>
<option value="0">Charmers Seven Day 12 Hours Processing — FREE</option>
</select>

<!-- Address -->
<input id="street" class="w-full p-3 border rounded" placeholder="Street Address">
<input id="street2" class="w-full p-3 border rounded" placeholder="Street Address 2 (optional)">
<input id="city" class="w-full p-3 border rounded" placeholder="City">
<input id="state" class="w-full p-3 border rounded" placeholder="State">
<input id="zip" class="w-full p-3 border rounded" placeholder="Postal Code">
<input id="country" class="w-full p-3 border rounded" placeholder="Country">

<!-- ToS -->
<div class="flex items-center space-x-2">
<input type="checkbox" id="tos">
<label class="text-sm">By buying from Charmers you agree to our ToS and usage policies.</label>
</div>

<!-- Total -->
<div class="p-4 bg-gray-100 rounded">
<p class="font-semibold">Bracelet Cost: <span id="braceletCost">$0.00</span></p>
<p class="font-semibold">Shipping: <span id="shippingCost">$0.00</span></p>
<p class="font-semibold">Processing: <span id="processingCost">$0.00</span></p>
<p class="font-semibold mt-2 text-xl">Total: <span id="grandTotal">$0.00</span></p>
</div>

<!-- Payment Buttons -->
<div id="payment-request-button" class="my-4"></div>

<!-- Card Element -->
<div id="card-element" class="p-3 border rounded"></div>
<button id="payBtn"
class="w-full p-3 bg-purple-600 text-white rounded mt-3 font-bold">
Pay Now
</button>

<!-- Success msg + EMAIL button -->
<p id="paymentSuccess" class="hidden text-green-600 font-bold mt-4 text-center">
Your order was processed. Expect a confirmation email from Charmers soon.
</p>

<button id="emailOrder"
class="hidden w-full p-3 bg-pink-500 text-white rounded font-bold mt-3">
Complete Order (Send Email)
</button>

</div>

</div>

<script>
/* ------------------------------ AUTOCOMPLETE ------------------------------ */
function initAutocomplete() {
    const input = document.getElementById("street");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.setFields(["address_components"]);

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        let city="", state="", zip="", country="";

        place.address_components.forEach(c => {
            const t = c.types[0];
            if (t === "locality") city = c.long_name;
            if (t === "administrative_area_level_1") state = c.short_name;
            if (t === "postal_code") zip = c.long_name;
            if (t === "country") country = c.long_name;
        });

        document.getElementById("city").value = city;
        document.getElementById("state").value = state;
        document.getElementById("zip").value = zip;
        document.getElementById("country").value = country;
    });
}
window.onload = initAutocomplete;

/* ------------------------------ PRICE ENGINE ------------------------------ */
function calculateTotal() {
    let bracelet = document.getElementById("bracelet").value.trim();
    let shipping = parseFloat(document.getElementById("shipping").value) || 0;
    let processing = parseFloat(document.getElementById("processing").value) || 0;

    let braceletCost = 0;
    let len = bracelet.length;

    if (len > 100) braceletCost = 9999;     // blocked tier
    else if (len > 30) braceletCost = 15;
    else if (len > 12) braceletCost = 10;
    else if (len >= 6) braceletCost = 6;
    else if (len > 0) braceletCost = 3;

    let tax = braceletCost * 0.07; // undisclosed tax
    let total = braceletCost + shipping + processing + tax;

    document.getElementById("braceletCost").innerText = "$" + braceletCost.toFixed(2);
    document.getElementById("shippingCost").innerText = "$" + shipping.toFixed(2);
    document.getElementById("processingCost").innerText = "$" + processing.toFixed(2);
    document.getElementById("grandTotal").innerText = "$" + total.toFixed(2);

    return total.toFixed(2);
}

["bracelet","shipping","processing"].forEach(id=>{
    document.getElementById(id).addEventListener("input", calculateTotal);
});

/* ------------------------------ STRIPE ------------------------------ */
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");
const elements = stripe.elements();

const cardElement = elements.create("card", { style: { base: { fontSize: "16px" } } });
cardElement.mount("#card-element");

/* Payment Request (Apple Pay / Google Pay / Link) */
const paymentRequest = stripe.paymentRequest({
    country: "US",
    currency: "usd",
    total: { label: "Charmers Order", amount: 1000 },
    requestPayerName: true,
    requestPayerEmail: true
});

paymentRequest.on("paymentmethod", async ev => {
    const total = Math.round(parseFloat(calculateTotal()) * 100);

    const result = await fetch("https://charmerspay.onrender.com/pay", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            amount: total,
            method: ev.paymentMethod.id
        })
    }).then(r=>r.json());

    if (result.success) {
        ev.complete("success");
        showSuccess();
    } else {
        ev.complete("fail");
    }
});

paymentRequest.canMakePayment().then(res => {
    if (res) {
        const prButton = elements.create("paymentRequestButton", {paymentRequest});
        prButton.mount("#payment-request-button");
    }
});

/* ------------------------------ CARD PAYMENT ------------------------------ */
document.getElementById("payBtn").onclick = async () => {
    if (!document.getElementById("tos").checked)
        return alert("You must agree to the ToS to continue.");

    const total = Math.round(parseFloat(calculateTotal()) * 100);

    const {paymentMethod, error} = await stripe.createPaymentMethod({
        type: "card",
        card: cardElement
    });

    if (error) return alert("Check the card number");

    const res = await fetch("https://charmerspay.onrender.com/pay", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({amount: total, method: paymentMethod.id})
    }).then(r=>r.json());

    if (res.success) showSuccess();
    else alert("The card was declined by your bank, try again later");
};

/* ------------------------- SUCCESS + EMAIL BUTTON ------------------------- */
function showSuccess() {
    document.getElementById("paymentSuccess").classList.remove("hidden");
    document.getElementById("emailOrder").classList.remove("hidden");
}

/* ------------------------------ EMAIL ORDER ------------------------------ */
document.getElementById("emailOrder").onclick = () => {
    const mail = "mailto:office@charmersbiz.org"
      + "?subject=New Charmers Order"
      + "&body="
      + encodeURIComponent(`
Name: ${name.value}
Email: ${email.value}
Phone: ${phone.value}
Bracelet: ${bracelet.value}
Shipping: ${shipping.value}
Processing: ${processing.value}
Address:
${street.value}
${street2.value}
${city.value}, ${state.value} ${zip.value}
${country.value}
Total Charged: $${calculateTotal()}
`);
    window.location.href = mail;
};
</script>

</body>
</html>
