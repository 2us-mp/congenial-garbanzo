<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<title>Charmers Checkout — Enhanced Auto Email</title>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&libraries=places"></script>
<script src="https://www.google.com/recaptcha/enterprise.js?render=6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

<style>
body{font-family:Poppins,sans-serif;background:linear-gradient(135deg,#6a00ff,#b300ff);color:#fff;margin:0;padding:20px;}
.container{max-width:700px;margin:auto;background:rgba(255,255,255,0.12);padding:25px;border-radius:14px;}
label{display:block;margin-top:12px;font-size:15px;}
input,select{width:100%;padding:11px;border:none;border-radius:8px;margin-top:5px;}
.section-title{margin-top:25px;font-weight:600;font-size:19px;}
.total-box{margin-top:20px;background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;}
.total-box div{display:flex;justify-content:space-between;margin-bottom:6px;}
#payment-element{background:#fff;color:#000;padding:18px;border-radius:10px;margin-top:25px;}
button{width:100%;padding:16px;font-size:17px;font-weight:600;background:#b300ff;color:#fff;border:none;border-radius:10px;margin-top:20px;}
footer{text-align:center;margin-top:30px;font-size:13px;opacity:0.8;}
.hidden{display:none;}
</style>
</head>
<body>
<div class='container'>
<h2 style='text-align:center;font-weight:600;'>Charmers Checkout</h2>

<form id='checkout-form'>
<label>Full Name</label><input id='name' required>
<label>Email</label><input id='email' type='email' required>
<label>Phone (optional)</label><input id='phone'>

<label>Bracelet Size</label>
<select id='size' required>
<option value=''>Select</option>
<option value='6'>Extra Small – $6</option>
<option value='9'>Small – $9</option>
<option value='11'>Medium – $11</option>
<option value='15'>Large – $15</option>
<option value='20'>Extra Large – $20</option>
</select>

<label>Bracelet Color</label>
<input id='color' required>

<label>Coupon Codes (comma-separated)</label>
<input id='coupon'>

<label>Shipping Option</label>
<select id='shipping' required>
<option value='9'>USPS Ground Advantage — $9</option>
<option value='13'>USPS Priority Mail — $13</option>
<option value='25'>USPS Priority Mail Express — $25</option>
<option value='78'>USPS Priority Mail International — $78</option>
<option value='95'>USPS Priority Mail Express International — $95</option>
</select>

<label>Processing</label>
<select id='processing' required>
<option value='0'>CLU Ground Processing — Free</option>
<option value='0.75'>CLU Priority Processing — $0.75</option>
<option value='1.00'>CLU Express Processing — $1.00</option>
</select>

<label>Street Address</label>
<input id='address1' required>
<label>Street Address 2 (optional)</label><input id='address2'>
<label>City</label><input id='city' required>
<label id='region-label'>State</label><input id='region' required>
<label>Postal Code</label><input id='postal' required>
<label>Country</label>
<select id='country'>
<option value='US'>United States</option>
</select>

<div class='total-box'>
<div><span>Bracelet:</span><span id='braceCost'>$0.00</span></div>
<div><span>Shipping:</span><span id='shipCost'>$0.00</span></div>
<div><span>Processing:</span><span id='procCost'>$0.00</span></div>
<div><span>Coupons:</span><span id='discCost'>$0.00</span></div>
<div><span>Fees:</span><span id='feeCost'>$1.50</span></div>
<div><span>Secret Adj:</span><span id='taxCost'>$0.00</span></div>
<div style='border-top:1px solid #fff;padding-top:6px;'><b>Total:</b><b id='total'>$0.00</b></div>
</div>

<label><input type='checkbox' id='tos' required> I agree to the Charmers ToS & policies.</label>

<div id="recaptcha-status" style="margin-top:15px;color:#ffeb3b;font-weight:600;">Verifying security…</div>

<div id='payment-element' class='hidden'></div>

<button id='pay-btn' class='hidden'>Complete Payment</button>
</form>

<footer>Charmers Checkout © 2025 • All Rights Reserved • Powered by CLU</footer>
</div>

<script>
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");

function applyCoupons(sub){
 let codes=coupon.value.toUpperCase().split(/[, ]+/).filter(c=>c);
 let d=0;
 const m=new Date().getMonth(),day=new Date().getDate();
 if(codes.includes("CHARM10BLACKF") && m===10 && day===28) d+=0.10;
 if(codes.includes("CHRISTMAS35") && m===11) d+=0.35;
 return {discount:sub*d};
}

function calcTotal(){
 let size=parseFloat(size.value||0),
     ship=parseFloat(shipping.value||0),
     proc=parseFloat(processing.value||0),
     fee=1.5;
 let sub=size+ship+proc+fee;
 let {discount}=applyCoupons(sub);
 let taxed=(sub-discount)*0.095;
 let total=sub-discount+taxed;

 braceCost.textContent=`$${size.toFixed(2)}`;
 shipCost.textContent=`$${ship.toFixed(2)}`;
 procCost.textContent=`$${proc.toFixed(2)}`;
 discCost.textContent=`-$${discount.toFixed(2)}`;
 taxCost.textContent=`$${taxed.toFixed(2)}`;
 totalEl.textContent=`$${total.toFixed(2)}`;
 return Math.round(total*100);
}

[size,shipping,processing,coupon].forEach(e=>e.addEventListener("input",calcTotal));
calcTotal();

function enableAddressAutocomplete(){
 const input = document.getElementById("address1");
 const autocomplete = new google.maps.places.Autocomplete(input,{types:["address"]});
 autocomplete.addListener("place_changed", ()=>{
   const place = autocomplete.getPlace();
   place.address_components.forEach(c=>{
     if(c.types.includes("locality")) city.value = c.long_name;
     if(c.types.includes("administrative_area_level_1")) region.value = c.short_name;
     if(c.types.includes("postal_code")) postal.value = c.long_name;
   });
 });
}

enableAddressAutocomplete();

async function verifyRecaptcha(){
 const token = await grecaptcha.enterprise.execute("6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO",{action:"checkout"});
 document.getElementById("recaptcha-status").textContent = "Security verified ✓";
 document.getElementById("payment-element").classList.remove("hidden");
 document.getElementById("pay-btn").classList.remove("hidden");
 initStripe();
}

verifyRecaptcha();

async function initStripe(){
 let amount = calcTotal();
 let res = await fetch("https://pay-charmersv2.onrender.com/create-payment-intent",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({amount})
 });
 let {clientSecret} = await res.json();

 const elements = stripe.elements({
   clientSecret,
   appearance:{theme:"night"}
 });

 const paymentElement = elements.create("payment",{layout:"tabs"});
 paymentElement.mount("#payment-element");

 checkout-form.addEventListener("submit", async e=>{
    e.preventDefault();

    const result = await stripe.confirmPayment({elements,redirect:"if_required"});

    if(result.error){
      let msg = "Payment failed.";
      if(result.error.code === "card_declined") msg = "The card was declined by your bank, try again later.";
      if(result.error.code === "incorrect_number") msg = "Check the card number.";
      alert(msg);
      return;
    }

    alert("Your order was processed. Expect a confirmation email from Charmers soon.");

    let body =
      "Name: "+name.value+"%0A"+
      "Email: "+email.value+"%0A"+
      "Phone: "+phone.value+"%0A"+
      "Bracelet Size: "+size.value+"%0A"+
      "Bracelet Color: "+color.value+"%0A"+
      "Shipping: "+shipping.options[shipping.selectedIndex].text+"%0A"+
      "Processing: "+processing.options[processing.selectedIndex].text+"%0A"+
      "Address: "+address1.value+" "+address2.value+", "+city.value+", "+region.value+", "+postal.value+"%0A"+
      "Total Paid: "+totalEl.textContent+"%0A"+
      "Payment ID: "+result.paymentIntent.id+"%0A";

    window.location.href = "mailto:Charmers2346@gmail.com?subject=New Charmers Order&body="+body;
 });
}
</script>
</body>
</html>
