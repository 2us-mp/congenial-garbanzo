<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charmers Checkout – Final Production</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script src="https://js.stripe.com/v3/"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:Poppins,sans-serif;
  background:#180028;
  margin:0;padding:20px;color:#fff;
}
.container{
  max-width:760px;margin:auto;
  background:#2d0050;
  padding:30px;border-radius:20px;
  box-shadow:0 0 18px rgba(0,0,0,0.35);
}
h2{text-align:center;font-weight:700;margin-bottom:25px;}
label{display:block;margin-top:15px;font-size:16px;}
input,select{
  width:100%;padding:14px;margin-top:6px;
  border:none;border-radius:10px;
  background:#ffffffd9;font-size:15px;
}

.total-box{
  background:#3a0070;
  padding:18px;border-radius:14px;
  margin-top:25px;
}
.total-box div{
  display:flex;justify-content:space-between;margin:6px 0;
}
.payment-panel{
  background:#fff;color:#000;padding:20px;
  border-radius:16px;margin-top:25px;
}
button{
  width:100%;padding:16px;margin-top:25px;
  border:none;border-radius:12px;font-size:18px;
  font-weight:600;background:#ff33dd;color:#fff;
  cursor:pointer;
}
button:disabled{
  background:#999;cursor:not-allowed;
}
</style>
</head>

<body>
<div class="container">
<h2>Charmers Checkout</h2>

<form id="checkoutForm">

<!-- CUSTOMER INFO -->
<label>Full Name</label>
<input id="name" required>

<label>Email</label>
<input id="email" type="email" required>

<label>Phone (optional)</label>
<input id="phone">

<!-- PRODUCT INFO -->
<label>Bracelet Size</label>
<select id="size" required>
  <option value="">Select</option>
  <option value="6">Extra Small – $6</option>
  <option value="9">Small – $9</option>
  <option value="11">Medium – $11</option>
  <option value="15">Large – $15</option>
  <option value="20">Extra Large – $20</option>
</select>

<label>Bracelet Color</label>
<input id="color" required>

<label>Coupon Code</label>
<input id="coupon">

<!-- SHIPPING -->
<label>Shipping Option</label>
<select id="shipping" required>
  <option value="9">USPS Ground Advantage – $9</option>
  <option value="13">USPS Priority Mail – $13</option>
  <option value="25">USPS Priority Mail Express – $25</option>
  <option value="78">USPS Priority Mail International – $78</option>
  <option value="95">USPS Priority Mail Express International – $95</option>
</select>

<!-- PROCESSING -->
<label>Processing</label>
<select id="processing" required>
  <option value="0">CLU Ground – Free</option>
  <option value="0.75">CLU Priority – $0.75</option>
  <option value="1.00">CLU Express – $1.00</option>
</select>

<!-- ADDRESS -->
<label>Street Address</label>
<input id="address1" required>

<label>Address Line 2 (optional)</label>
<input id="address2">

<label>City</label>
<input id="city" required>

<label>State</label>
<input id="region" required>

<label>Postal Code</label>
<input id="postal" required>

<label>Country</label>
<select id="country">
  <option value="US">United States</option>
</select>

<!-- TOTAL BOX -->
<div class="total-box">
  <div><span>Bracelet:</span><span id="braceCost">$0.00</span></div>
  <div><span>Shipping:</span><span id="shipCost">$0.00</span></div>
  <div><span>Processing:</span><span id="procCost">$0.00</span></div>
  <div><span>Coupon:</span><span id="discCost">-$0.00</span></div>
  <div><span>Fees:</span><span id="feeCost">$1.50</span></div>
  <div><span>Tax:</span><span id="taxCost">$0.00</span></div>
  <hr>
  <div><b>Total:</b><b id="total">$0.00</b></div>
</div>

<label>
  <input type="checkbox" id="tos" required>
  I agree to the Charmers Terms of Service
</label>

<!-- PAYMENT SECTION -->
<div class="payment-panel">
<h3>Payment</h3>

<div id="payment-request-wrapper" style="margin-bottom:15px;"></div>
<div id="card-element"></div>
</div>

<button id="payBtn" disabled>Complete Payment</button>

</form>

</div>

<script>
/* ---------------------------
   INIT STRIPE
---------------------------- */
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");

let elements;
let card;
let clientSecret = null;
let pr;
let prButtonMounted = false;

/* ---------------------------
   DOM ELEMENTS
---------------------------- */
const sizeEl = document.getElementById("size");
const shipEl = document.getElementById("shipping");
const procEl = document.getElementById("processing");
const couponEl = document.getElementById("coupon");

const braceCost = document.getElementById("braceCost");
const shipCost = document.getElementById("shipCost");
const procCost = document.getElementById("procCost");
const discCost = document.getElementById("discCost");
const feeCost = document.getElementById("feeCost");
const taxCost = document.getElementById("taxCost");
const totalEl = document.getElementById("total");

/* ---------------------------
   COUPONS
---------------------------- */
function applyCoupons(sub){
  const c = couponEl.value.trim().toUpperCase();
  let d = 0;
  if(c==="CHARM10BLACKF") d = 0.10;
  if(c==="CHRISTMAS35") d = 0.35;
  return {discount: sub * d};
}

/* ---------------------------
   CALCULATE TOTAL
---------------------------- */
function calcTotal(){
  const size = parseFloat(sizeEl.value||0);
  const ship = parseFloat(shipEl.value||0);
  const proc = parseFloat(procEl.value||0);
  const fee = 1.50;

  let subtotal = size + ship + proc + fee;
  let {discount} = applyCoupons(subtotal);

  let taxable = size;
  let tax = taxable * 0.095;
  let total = subtotal - discount + tax;

  braceCost.textContent = "$" + size.toFixed(2);
  shipCost.textContent = "$" + ship.toFixed(2);
  procCost.textContent = "$" + proc.toFixed(2);
  discCost.textContent = "-$" + discount.toFixed(2);
  feeCost.textContent = "$1.50";
  taxCost.textContent = "$" + tax.toFixed(2);
  totalEl.textContent = "$" + total.toFixed(2);

  return Math.round(total * 100);
}

/* ---------------------------
   VALIDATION
---------------------------- */
function validateForm(){
  const required = [
    "name","email","size","color",
    "shipping","processing","address1",
    "city","region","postal"
  ];

  for(let id of required){
    if(!document.getElementById(id).value.trim()) return false;
  }

  return document.getElementById("tos").checked;
}

function updateButtons(){
  document.getElementById("payBtn").disabled = !validateForm();
}

/* ---------------------------
   CREATE PAYMENT INTENT (ONCE)
---------------------------- */
async function updateIntent(){
  const amount = calcTotal();

  const res = await fetch("https://pay-charmersv2.onrender.com/create-payment-intent",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({amount})
  });

  const data = await res.json();
  clientSecret = data.clientSecret;

  if(card){
    card.unmount();
  }

  elements = stripe.elements({clientSecret});
  card = elements.create("payment",{layout:"tabs"});
  card.mount("#card-element");

  setupPaymentRequest(amount);
}

/* ---------------------------
   APPLE PAY / GOOGLE PAY
---------------------------- */
function setupPaymentRequest(amount){
  if(!pr){
    pr = stripe.paymentRequest({
      country:"US",
      currency:"usd",
      total:{label:"Charmers Order",amount},
      requestPayerName:true,
      requestPayerEmail:true
    });
  } else {
    pr.update({
      total:{label:"Charmers Order",amount}
    });
  }

  if(!prButtonMounted){
    const prButton = elements.create("paymentRequestButton",{paymentRequest:pr});
    pr.canMakePayment().then(result=>{
      if(result){
        document.getElementById("payment-request-wrapper").innerHTML = "";
        prButton.mount("#payment-request-wrapper");
        prButtonMounted = true;
      }
    });
  }
}

/* ---------------------------
   CHANGE EVENTS
---------------------------- */
[sizeEl, shipEl].forEach(el=>{
  el.addEventListener("change",()=>{
    updateIntent();
    updateButtons();
  });
});

[couponEl, procEl].forEach(el=>{
  el.addEventListener("change",()=>{
    calcTotal();
    updateButtons();
  });
});

document.querySelectorAll("input").forEach(el=>{
  el.addEventListener("input",updateButtons);
});

/* ---------------------------
   INITIAL LOAD
---------------------------- */
calcTotal();
updateButtons();
updateIntent();

/* ---------------------------
   PROCESS PAYMENT
---------------------------- */
document.getElementById("checkoutForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const result = await stripe.confirmPayment({
    elements,
    clientSecret,
    redirect:"if_required"
  });

  if(result.error){
    alert("Payment failed: "+result.error.message);
    return;
  }

  const body =
    "Name: "+name.value+"%0A"+
    "Email: "+email.value+"%0A"+
    "Phone: "+phone.value+"%0A"+
    "Bracelet Size: "+sizeEl.options[sizeEl.selectedIndex].text+"%0A"+
    "Bracelet Color: "+color.value+"%0A"+
    "Shipping: "+shipEl.options[shipEl.selectedIndex].text+"%0A"+
    "Processing: "+procEl.options[procEl.selectedIndex].text+"%0A"+
    "Address: "+address1.value+" "+address2.value+
      ", "+city.value+", "+region.value+" "+postal.value+"%0A"+
    "Total Paid: "+totalEl.textContent+"%0A"+
    "Payment ID: "+result.paymentIntent.id;

  window.location.href =
    "mailto:Charmers2346@gmail.com?subject=New Charmers Order&body="+body;
});
</script>

</body>
</html>
