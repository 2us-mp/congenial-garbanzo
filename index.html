<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Charmers Bracelets</title>
    
    <!-- External CSS File -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* Product gallery styles */
        .product-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }
        
        .product-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .product-card.selected {
            border-color: #5a17ff;
            border-width: 3px;
            box-shadow: 0 0 0 2px rgba(90, 23, 255, 0.1);
        }
        
        .product-image {
            height: 200px;
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .no-photo {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .no-photo i {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #1a1a1a;
        }
        
        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #5a17ff;
            margin: 0 0 12px 0;
        }
        
        .product-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0 0 16px 0;
        }
        
        .select-btn {
            width: 100%;
            padding: 12px;
            background: #5a17ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .select-btn:hover {
            background: #4a0fe6;
        }
        
        .select-btn.selected {
            background: #ff5aaa;
        }
        
        .cart-summary {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #5a17ff;
            padding: 16px;
            display: none;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        .cart-summary.show {
            display: block;
        }
        
        .checkout-flow {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .flow-step {
            display: none;
        }
        
        .flow-step.active {
            display: block;
        }
        
        .flow-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: #5a17ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .nav-btn:hover {
            background: #4a0fe6;
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .nav-btn.secondary {
            background: #666;
        }
        
        .flow-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 32px 0;
        }
        
        .flow-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }
        
        .flow-dot.active {
            background: #5a17ff;
        }
        
        .flow-title {
            text-align: center;
            margin-bottom: 32px;
            color: #1a1a1a;
        }
        
        .product-summary {
            background: #f8f8ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .product-summary h3 {
            margin-top: 0;
            color: #5a17ff;
        }
        
        .size-options {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }
        
        .size-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .size-option:hover {
            border-color: #5a17ff;
        }
        
        .size-option.selected {
            border-color: #5a17ff;
            background: #f0eaff;
            font-weight: 600;
        }
        
        .size-price {
            display: block;
            margin-top: 4px;
            color: #5a17ff;
            font-weight: 600;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-total {
            font-size: 1.3rem;
            font-weight: 700;
            color: #5a17ff;
            text-align: right;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Charmers Bracelets</h1>
    </header>

    <div class="banner">
        We're on eBay! <a href="https://ebay.us/m/S51i6y" target="_blank">Visit our store</a>
    </div>

    <main>
        <!-- Step 1: Product Selection -->
        <div class="checkout-flow">
            <div class="flow-indicator">
                <div class="flow-dot active" id="dot-1"></div>
                <div class="flow-dot" id="dot-2"></div>
                <div class="flow-dot" id="dot-3"></div>
                <div class="flow-dot" id="dot-4"></div>
            </div>
            
            <div id="step-1" class="flow-step active">
                <h2 class="flow-title">Choose Your Bracelet</h2>
                
                <div class="product-gallery">
                    <!-- Birthstone Bracelet -->
                    <div class="product-card" data-product="birthstone">
                        <div class="product-image">
                            <div class="no-photo">
                                <div style="font-size: 48px; margin-bottom: 12px;">üíé</div>
                                <strong>No photo available</strong><br>
                                <small>Images coming soon</small>
                            </div>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">Charmers Birthstone Series</h3>
                            <p class="product-price">Starting at $5</p>
                            <p class="product-description">Personalized birthstone bracelet. 10% of profits donated to Montessori School of Franklin.</p>
                            <button class="select-btn" onclick="selectProduct('birthstone')">Select This Bracelet</button>
                        </div>
                    </div>
                    
                    <!-- Heart Bracelet -->
                    <div class="product-card" data-product="heart">
                        <div class="product-image">
                            <div class="no-photo">
                                <div style="font-size: 48px; margin-bottom: 12px;">üíñ</div>
                                <strong>No photo available</strong><br>
                                <small>Images coming soon</small>
                            </div>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">Charmers Heart Bracelet</h3>
                            <p class="product-price">Starting at $5</p>
                            <p class="product-description">Beautiful pink & purple heart design. Perfect for any occasion.</p>
                            <button class="select-btn" onclick="selectProduct('heart')">Select This Bracelet</button>
                        </div>
                    </div>
                    
                    <!-- Custom Bracelet -->
                    <div class="product-card" data-product="custom">
                        <div class="product-image">
                            <div class="no-photo">
                                <div style="font-size: 48px; margin-bottom: 12px;">üé®</div>
                                <strong>No photo available</strong><br>
                                <small>Custom design - your creation</small>
                            </div>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">Create Your Own Bracelet</h3>
                            <p class="product-price">Starting at $5</p>
                            <p class="product-description">Design your own unique bracelet. Choose colors, theme, and more!</p>
                            <button class="select-btn" onclick="selectProduct('custom')">Create Custom Bracelet</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Customization -->
            <div id="step-2" class="flow-step">
                <h2 class="flow-title">Customize Your <span id="product-name">Bracelet</span></h2>
                
                <div class="product-summary">
                    <h3>Selected: <span id="selected-product-name">Birthstone Bracelet</span></h3>
                </div>
                
                <!-- Birthstone customization -->
                <div id="birthstone-customization" class="bracelet-customization" style="display: none;">
                    <label for="birthstone-input">Your birthstone month</label>
                    <input id="birthstone-input" type="text" placeholder="e.g., April, May, Emerald" class="customization-input">
                    
                    <label>Select size</label>
                    <div class="size-options">
                        <div class="size-option" data-size="small" data-price="5">
                            Small<br>
                            <span class="size-price">$5</span>
                        </div>
                        <div class="size-option" data-size="medium" data-price="9">
                            Medium<br>
                            <span class="size-price">$9</span>
                        </div>
                        <div class="size-option" data-size="large" data-price="11">
                            Large<br>
                            <span class="size-price">$11</span>
                        </div>
                        <div class="size-option" data-size="xlarge" data-price="15">
                            X-Large<br>
                            <span class="size-price">$15</span>
                        </div>
                    </div>
                    
                    <label for="birthstone-personalization">Personalization text (optional)</label>
                    <textarea id="birthstone-personalization" rows="3" placeholder="Add a special message or name" class="customization-input"></textarea>
                </div>
                
                <!-- Heart customization -->
                <div id="heart-customization" class="bracelet-customization" style="display: none;">
                    <p style="color: #666; font-style: italic;">Colors fixed to pink & purple.</p>
                    
                    <label>Select size</label>
                    <div class="size-options">
                        <div class="size-option" data-size="small" data-price="5">
                            Small<br>
                            <span class="size-price">$5</span>
                        </div>
                        <div class="size-option" data-size="medium" data-price="9">
                            Medium<br>
                            <span class="size-price">$9</span>
                        </div>
                        <div class="size-option" data-size="large" data-price="11">
                            Large<br>
                            <span class="size-price">$11</span>
                        </div>
                        <div class="size-option" data-size="xlarge" data-price="15">
                            X-Large<br>
                            <span class="size-price">$15</span>
                        </div>
                    </div>
                    
                    <label for="heart-personalization">Personalization text (optional)</label>
                    <textarea id="heart-personalization" rows="3" placeholder="Add a special message or name" class="customization-input"></textarea>
                </div>
                
                <!-- Custom bracelet customization -->
                <div id="custom-customization" class="bracelet-customization" style="display: none;">
                    <label for="custom-feature">What do you want it to feature?</label>
                    <input id="custom-feature" type="text" placeholder="Describe your design or theme" class="customization-input">
                    
                    <label for="custom-color">Primary color</label>
                    <select id="custom-color" class="customization-input">
                        <option value="">Select a color</option>
                        <option value="red">Red</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                    </select>
                    
                    <label for="custom-color-custom">Or enter custom color</label>
                    <input id="custom-color-custom" type="text" placeholder="Custom color name" class="customization-input">
                    
                    <label for="custom-color2">Optional second color</label>
                    <select id="custom-color2" class="customization-input">
                        <option value="">Select a color (optional)</option>
                        <option value="red">Red</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                    </select>
                    
                    <label>Select size</label>
                    <div class="size-options">
                        <div class="size-option" data-size="small" data-price="5">
                            Small<br>
                            <span class="size-price">$5</span>
                        </div>
                        <div class="size-option" data-size="medium" data-price="9">
                            Medium<br>
                            <span class="size-price">$9</span>
                        </div>
                        <div class="size-option" data-size="large" data-price="11">
                            Large<br>
                            <span class="size-price">$11</span>
                        </div>
                        <div class="size-option" data-size="xlarge" data-price="15">
                            X-Large<br>
                            <span class="size-price">$15</span>
                        </div>
                    </div>
                    
                    <label for="donation">Donate to (optional)</label>
                    <select id="donation" class="customization-input">
                        <option value="remove_co2">Remove CO‚ÇÇ from our environment</option>
                        <option value="msf">Montessori School of Franklin</option>
                        <option value="none">No donation</option>
                    </select>
                    
                    <label for="custom-personalization">Personalization text (optional)</label>
                    <textarea id="custom-personalization" rows="3" placeholder="Add a special message or name" class="customization-input"></textarea>
                </div>
                
                <div class="flow-navigation">
                    <button class="nav-btn secondary" onclick="goToStep(1)">‚Üê Back</button>
                    <button class="nav-btn" onclick="goToStep(3)">Continue to Shipping ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 3: Shipping -->
            <div id="step-3" class="flow-step">
                <h2 class="flow-title">Shipping Information</h2>
                
                <div class="product-summary" id="order-summary">
                    <!-- Order summary will be populated here -->
                </div>
                
                <div class="section">
                    <label for="shipping-option">Shipping method *</label>
                    <select id="shipping-option" required>
                        <option value="">Select shipping</option>
                        <option value="usps_ground" data-price="9">USPS Ground Advantage ‚Äî $9</option>
                        <option value="usps_priority" data-price="11">USPS Priority Mail ‚Äî $11</option>
                        <option value="usps_express" data-price="29">USPS Priority Mail Express ‚Äî $29</option>
                        <option value="ups_exp" data-price="93">UPS Worldwide Expedited ‚Äî $93</option>
                        <option value="ups_expr" data-price="119">UPS Worldwide Express ‚Äî $119</option>
                    </select>
                    
                    <h3 style="margin-top: 24px;">Shipping Address</h3>
                    
                    <label for="name">Full name *</label>
                    <input id="name" type="text" placeholder="Your full name" required>
                    
                    <label for="email">Email address *</label>
                    <input id="email" type="email" placeholder="you@example.com" required>
                    
                    <label for="phone">Phone number (optional)</label>
                    <input id="phone" type="tel" placeholder="(123) 456-7890">
                    
                    <label for="address1">Street address *</label>
                    <input id="address1" type="text" placeholder="123 Main St" required>
                    
                    <label for="address2">Apartment, suite, etc. (optional)</label>
                    <input id="address2" type="text" placeholder="Apt 4B">
                    
                    <div class="inline-group">
                        <div>
                            <label for="city">City *</label>
                            <input id="city" type="text" placeholder="City" required>
                        </div>
                        <div>
                            <label for="state">State / Province *</label>
                            <input id="state" type="text" placeholder="State" required>
                        </div>
                    </div>
                    
                    <div class="inline-group">
                        <div>
                            <label for="postal">ZIP / Postal code *</label>
                            <input id="postal" type="text" placeholder="12345" required>
                        </div>
                        <div>
                            <label for="country">Country *</label>
                            <input id="country" type="text" placeholder="United States" required>
                        </div>
                    </div>
                </div>
                
                <div class="flow-navigation">
                    <button class="nav-btn secondary" onclick="goToStep(2)">‚Üê Back</button>
                    <button class="nav-btn" onclick="goToStep(4)">Continue to Payment ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 4: Payment -->
            <div id="step-4" class="flow-step">
                <h2 class="flow-title">Payment</h2>
                
                <div class="section">
                    <div id="payment-request-button" class="hidden"></div>
                    
                    <div id="card-element" style="margin-top:16px;"></div>
                    
                    <div id="card-errors" role="alert" style="color:#c00; margin-top:8px;"></div>
                    
                    <button id="card-button" class="nav-btn" style="width: 100%; margin-top: 20px;">Pay Now</button>
                </div>
                
                <div class="flow-navigation">
                    <button class="nav-btn secondary" onclick="goToStep(3)">‚Üê Back to Shipping</button>
                </div>
            </div>
            
            <!-- Success Step -->
            <div id="step-success" class="flow-step">
                <div style="text-align: center; padding: 40px 20px;">
                    <h2 style="color: #5a17ff;">üéâ Order Successful!</h2>
                    <p>Your payment was successful and your order has been saved to our system.</p>
                    <p>Expect a confirmation email from Charmers soon.</p>
                    <button id="dashboard-button" class="nav-btn" style="margin-top: 20px;">View Order Dashboard</button>
                </div>
            </div>
        </div>
        
        <!-- Cart Summary (sticky bottom) -->
        <div class="cart-summary" id="cart-summary">
            <div class="cart-item">
                <span id="cart-product-name">No product selected</span>
                <span id="cart-product-price">$0.00</span>
            </div>
            <div class="cart-item">
                <span>Shipping</span>
                <span id="cart-shipping-price">$0.00</span>
            </div>
            <div class="cart-item">
                <strong>Total</strong>
                <strong id="cart-total-price">$0.00</strong>
            </div>
            <button id="checkout-btn" class="nav-btn" style="width: 100%; margin-top: 16px;">Proceed to Checkout</button>
        </div>
    </main>

    <script>
    // Configuration
    const BACKEND_URL = 'https://pay-charmersv2.onrender.com';
    const stripePublicKey = 'pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc';
    
    const paymentIntentUrl = `${BACKEND_URL}/create-payment-intent`;
    const saveOrderUrl = `${BACKEND_URL}/save-order`;

    // State
    let selectedProduct = null;
    let selectedSize = null;
    let braceletPrice = 0;
    let shippingPrice = 0;
    let stripe = null;
    let elements = null;
    let card = null;

    // Product data
    const products = {
        birthstone: {
            name: 'Birthstone Bracelet',
            basePrice: 5,
            customization: 'birthstone'
        },
        heart: {
            name: 'Heart Bracelet',
            basePrice: 5,
            customization: 'heart'
        },
        custom: {
            name: 'Custom Bracelet',
            basePrice: 5,
            customization: 'custom'
        }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initStripe();
        updateCartSummary();
    });

    function initStripe() {
        stripe = Stripe(stripePublicKey);
        elements = stripe.elements();
        
        const style = {
            base: {
                color: "#32325d",
                fontFamily: 'Arial, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": { color: "#a0a0a0" }
            },
            invalid: { color: "#fa755a", iconColor: "#fa755a" }
        };
        
        card = elements.create("card", {style: style});
        card.mount("#card-element");
        
        card.on('change', (event) => {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        
        // Initialize Payment Request Button
        initPaymentRequestButton();
    }

    function initPaymentRequestButton() {
        const paymentRequest = stripe.paymentRequest({
            country: 'US',
            currency: 'usd',
            total: {
                label: 'Charmers Bracelet',
                amount: 0,
            },
            requestPayerName: true,
            requestPayerEmail: true,
            requestPayerPhone: true,
            requestShipping: true,
            shippingOptions: [
                {
                    id: 'usps_ground',
                    label: 'USPS Ground Advantage',
                    detail: 'Delivery in 3-5 business days',
                    amount: 900,
                },
                {
                    id: 'usps_priority',
                    label: 'USPS Priority Mail',
                    detail: 'Delivery in 1-3 business days',
                    amount: 1100,
                }
            ]
        });

        const prButton = elements.create('paymentRequestButton', {
            paymentRequest,
            style: {
                paymentRequestButton: {
                    theme: 'dark',
                    height: '48px',
                }
            }
        });

        paymentRequest.canMakePayment().then(result => {
            if (result) {
                document.getElementById('payment-request-button').classList.remove('hidden');
                prButton.mount('#payment-request-button');
                
                paymentRequest.on('paymentmethod', async (ev) => {
                    if (!validateShippingForm()) {
                        ev.complete('fail');
                        alert('Please complete all required fields.');
                        return;
                    }

                    const orderData = prepareOrderData();
                    const amountCents = Math.round(orderData.total * 100);

                    try {
                        const response = await fetch(paymentIntentUrl, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                amount: amountCents,
                                currency: 'usd',
                                orderDetails: orderData.orderDetails,
                                customerInfo: orderData.customerInfo,
                                shipping: orderData.shipping
                            })
                        });
                        
                        const pi = await response.json();
                        if (pi.error) {
                            ev.complete('fail');
                            return;
                        }

                        const { error } = await stripe.confirmCardPayment(
                            pi.clientSecret,
                            { payment_method: ev.paymentMethod.id },
                            { handleActions: false }
                        );

                        if (error) {
                            ev.complete('fail');
                        } else {
                            await saveOrderToBackend(pi.paymentIntentId || pi.id, orderData);
                            ev.complete('success');
                            showSuccess();
                        }
                    } catch (error) {
                        ev.complete('fail');
                    }
                });
            }
        });
    }

    // Product selection
    function selectProduct(productType) {
        selectedProduct = productType;
        
        // Update UI
        document.querySelectorAll('.product-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-product="${productType}"]`).classList.add('selected');
        
        document.querySelectorAll('.select-btn').forEach(btn => {
            btn.textContent = 'Select This Bracelet';
            btn.classList.remove('selected');
        });
        event.target.textContent = '‚úì Selected';
        event.target.classList.add('selected');
        
        // Show cart summary
        document.getElementById('cart-summary').classList.add('show');
        
        // Update product name in next step
        document.getElementById('product-name').textContent = products[productType].name;
        document.getElementById('selected-product-name').textContent = products[productType].name;
        
        // Update cart
        updateCartSummary();
        
        // Enable checkout button
        document.getElementById('checkout-btn').disabled = false;
    }

    function updateCartSummary() {
        const cartProductName = document.getElementById('cart-product-name');
        const cartProductPrice = document.getElementById('cart-product-price');
        const cartShippingPrice = document.getElementById('cart-shipping-price');
        const cartTotalPrice = document.getElementById('cart-total-price');
        
        if (selectedProduct) {
            cartProductName.textContent = products[selectedProduct].name;
            cartProductPrice.textContent = `$${braceletPrice.toFixed(2)}`;
        } else {
            cartProductName.textContent = 'No product selected';
            cartProductPrice.textContent = '$0.00';
        }
        
        cartShippingPrice.textContent = `$${shippingPrice.toFixed(2)}`;
        
        const total = braceletPrice + shippingPrice;
        cartTotalPrice.textContent = `$${total.toFixed(2)}`;
        
        // Update checkout button text
        document.getElementById('checkout-btn').textContent = `Checkout - $${total.toFixed(2)}`;
    }

    // Flow navigation
    let currentStep = 1;

    function goToStep(step) {
        // Validate current step before proceeding
        if (step > currentStep) {
            if (currentStep === 1 && !selectedProduct) {
                alert('Please select a bracelet first.');
                return;
            }
            if (currentStep === 2 && !validateCustomization()) {
                alert('Please complete all required customization options.');
                return;
            }
            if (currentStep === 3 && !validateShippingForm()) {
                alert('Please complete all required shipping information.');
                return;
            }
        }
        
        // Hide all steps
        document.querySelectorAll('.flow-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Update dots
        document.querySelectorAll('.flow-dot').forEach((dot, index) => {
            dot.classList.remove('active');
            if (index < step) {
                dot.classList.add('active');
            }
        });
        
        // Show target step
        document.getElementById(`step-${step}`).classList.add('active');
        currentStep = step;
        
        // Special handling for step 2
        if (step === 2 && selectedProduct) {
            showCustomization(selectedProduct);
            updateOrderSummary();
        }
        
        // Special handling for step 4
        if (step === 4) {
            updateOrderSummary();
        }
    }

    // Checkout button
    document.getElementById('checkout-btn').addEventListener('click', function() {
        if (!selectedProduct) {
            alert('Please select a bracelet first.');
            return;
        }
        goToStep(2);
    });

    // Size selection
    document.addEventListener('click', function(e) {
        if (e.target.closest('.size-option')) {
            const sizeOption = e.target.closest('.size-option');
            
            // Remove selected from all sizes
            document.querySelectorAll('.size-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected to clicked size
            sizeOption.classList.add('selected');
            
            // Update price
            selectedSize = sizeOption.dataset.size;
            braceletPrice = parseFloat(sizeOption.dataset.price);
            
            updateCartSummary();
            updateOrderSummary();
        }
    });

    function showCustomization(productType) {
        // Hide all customizations
        document.querySelectorAll('.bracelet-customization').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show selected customization
        const customizationId = `${products[productType].customization}-customization`;
        document.getElementById(customizationId).style.display = 'block';
        
        // Reset size selection
        document.querySelectorAll('.size-option').forEach(option => {
            option.classList.remove('selected');
        });
        selectedSize = null;
        braceletPrice = products[productType].basePrice;
        
        updateCartSummary();
    }

    function validateCustomization() {
        if (!selectedSize) {
            alert('Please select a size.');
            return false;
        }
        
        if (selectedProduct === 'birthstone') {
            const birthstone = document.getElementById('birthstone-input').value.trim();
            if (!birthstone) {
                alert('Please enter your birthstone month.');
                return false;
            }
        }
        
        if (selectedProduct === 'custom') {
            const feature = document.getElementById('custom-feature').value.trim();
            if (!feature) {
                alert('Please describe what you want your bracelet to feature.');
                return false;
            }
        }
        
        return true;
    }

    function validateShippingForm() {
        const requiredFields = ['name', 'email', 'address1', 'city', 'state', 'postal', 'country', 'shipping-option'];
        
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                alert(`Please fill in ${field.placeholder || fieldId}`);
                field.focus();
                return false;
            }
        }
        
        // Validate email format
        const email = document.getElementById('email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Please enter a valid email address.');
            return false;
        }
        
        // Update shipping price
        const shippingOption = document.getElementById('shipping-option');
        const selectedOption = shippingOption.options[shippingOption.selectedIndex];
        shippingPrice = parseFloat(selectedOption.dataset.price) || 0;
        updateCartSummary();
        
        return true;
    }

    function updateOrderSummary() {
        const summaryDiv = document.getElementById('order-summary');
        let summaryHTML = `<h3>Order Summary</h3>`;
        
        if (selectedProduct) {
            summaryHTML += `
                <p><strong>Product:</strong> ${products[selectedProduct].name}</p>
                <p><strong>Size:</strong> ${selectedSize ? selectedSize.charAt(0).toUpperCase() + selectedSize.slice(1) : 'Not selected'}</p>
            `;
            
            if (selectedProduct === 'birthstone') {
                const birthstone = document.getElementById('birthstone-input').value;
                if (birthstone) summaryHTML += `<p><strong>Birthstone:</strong> ${birthstone}</p>`;
            }
            
            if (selectedProduct === 'custom') {
                const feature = document.getElementById('custom-feature').value;
                if (feature) summaryHTML += `<p><strong>Feature:</strong> ${feature}</p>`;
            }
            
            summaryHTML += `
                <p><strong>Bracelet Price:</strong> $${braceletPrice.toFixed(2)}</p>
                <p><strong>Shipping:</strong> $${shippingPrice.toFixed(2)}</p>
                <p style="font-size: 1.2rem; color: #5a17ff; margin-top: 10px;">
                    <strong>Total: $${(braceletPrice + shippingPrice).toFixed(2)}</strong>
                </p>
            `;
        } else {
            summaryHTML += `<p>No product selected</p>`;
        }
        
        summaryDiv.innerHTML = summaryHTML;
    }

    function prepareOrderData() {
        const total = braceletPrice + shippingPrice;
        const type = selectedProduct;
        
        const orderDetails = {
            braceletType: type,
            total: total,
            size: selectedSize
        };

        // Add product-specific details
        if (type === 'birthstone') {
            orderDetails.birthstone = document.getElementById('birthstone-input').value;
            orderDetails.personalization = document.getElementById('birthstone-personalization').value;
        } else if (type === 'heart') {
            orderDetails.personalization = document.getElementById('heart-personalization').value;
        } else {
            orderDetails.feature = document.getElementById('custom-feature').value;
            orderDetails.color = document.getElementById('custom-color').value || 
                                document.getElementById('custom-color-custom').value;
            orderDetails.color2 = document.getElementById('custom-color2').value;
            orderDetails.donation = document.getElementById('donation').value;
            orderDetails.personalization = document.getElementById('custom-personalization').value;
        }

        const customerInfo = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value || ''
        };

        const shipping = {
            address1: document.getElementById('address1').value,
            address2: document.getElementById('address2').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            postal
